<div class="booking-container">
  <!-- Breadcrumb Navigation -->
  <app-breadcrumb></app-breadcrumb>
  
  <!-- Premium Progress Steps - Always visible -->
  <div class="container my-5">
    <div class="booking-progress-premium mb-5" [class.sticky-active]="isProgressSticky">
      <div class="progress-steps-premium">
        <div class="step-premium" [class.active]="isStep(1)" [class.completed]="currentStep > 1">
          <div class="step-icon-wrapper">
            <i class="bi bi-calendar-check"></i>
          </div>
          <div class="step-content">
            <div class="step-number">1</div>
            <div class="step-label">Package & Dates</div>
          </div>
        </div>
        <div class="step-connector" [class.completed]="currentStep > 1"></div>
        <div class="step-premium" [class.active]="isStep(2)" [class.completed]="currentStep > 2">
          <div class="step-icon-wrapper">
            <i class="bi bi-door-open"></i>
          </div>
          <div class="step-content">
            <div class="step-number">2</div>
            <div class="step-label">Room Selection</div>
          </div>
        </div>
        <div class="step-connector" [class.completed]="currentStep > 2"></div>
        <div class="step-premium" [class.active]="isStep(3)" [class.completed]="currentStep > 3">
          <div class="step-icon-wrapper">
            <i class="bi bi-person-check"></i>
          </div>
          <div class="step-content">
            <div class="step-number">3</div>
            <div class="step-label">Passenger Details</div>
          </div>
        </div>
        <div class="step-connector" [class.completed]="currentStep > 3"></div>
        <div class="step-premium" [class.active]="isStep(4)" [class.completed]="currentStep > 4">
          <div class="step-icon-wrapper">
            <i class="bi bi-plus-circle"></i>
          </div>
          <div class="step-content">
            <div class="step-number">4</div>
            <div class="step-label">Add-ons</div>
          </div>
        </div>
        <div class="step-connector" [class.completed]="currentStep > 4"></div>
        <div class="step-premium" [class.active]="isStep(5)" [class.completed]="currentStep > 5">
          <div class="step-icon-wrapper">
            <i class="bi bi-check2-square"></i>
          </div>
          <div class="step-content">
            <div class="step-number">5</div>
            <div class="step-label">Review & Payment</div>
          </div>
        </div>
      </div>
      <div class="progress-bar-premium">
        <div class="progress-fill-premium" [style.width.%]="(currentStep / 5) * 100"></div>
      </div>
    </div>

    <!-- Step Content - Only show when package is loaded -->
    <div class="row g-4" *ngIf="package">
      <!-- Form Content - Left Side -->
      <div class="col-12 col-lg-8">
        
        <!-- Step 1: Package & Dates -->
        <div *ngIf="isStep(1)" class="booking-step-content">
            <h3 class="step-title mb-4">
              <i class="bi bi-calendar-check me-2"></i>
              Confirm Your Package & Dates
            </h3>
            <div class="card border-0 shadow-sm mb-4 package-summary-card">
            <div class="card-body p-4">
              <div class="row align-items-center">
                <div class="col-md-3">
                  <img [src]="package!.imageUrl" [alt]="package!.name" class="package-image rounded-3">
                </div>
                <div class="col-md-9">
                  <h4 class="package-name mb-2">{{ package!.name }}</h4>
                  <div class="package-meta mb-3">
                    <span class="badge badge-type me-2">{{ package!.type }}</span>
                    <span class="badge badge-category me-2">{{ package!.category }}</span>
                    <span class="package-duration">
                      {{ package!.days }}D / {{ package!.nights }}N
                    </span>
                  </div>
                  <div class="package-details">
                    <p class="mb-0 departure-date">
                      <i class="bi bi-calendar-event me-2"></i>
                      {{ departureDate | date:'EEEE, MMMM d, yyyy' }}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

        <!-- Step 2: Room Selection -->
        <!-- Debug info - Force re-evaluation -->
        <div class="alert alert-info mb-3" *ngIf="true" style="font-size: 0.9rem;">
          <strong>üîç TEMPLATE DEBUG:</strong><br>
          currentStep={{ currentStep }} (type: {{ getCurrentStepType() }})<br>
          isStep(2)={{ isStep(2) }}<br>
          package={{ !!package }}<br>
          roomOptions={{ (package.roomOptions && package.roomOptions.length) || 0 }}<br>
          timestamp={{ getCurrentTime() }}<br>
          <small>Template evaluated at: {{ getCurrentTime() }}</small>
        </div>
        
        <!-- Force visibility test -->
        <div *ngIf="isStep(2)" class="booking-step-content" style="border: 3px solid #28a745; background: #f0fff4; padding: 1rem;">
          <div class="alert alert-success mb-3">
            <strong>‚úÖ STEP 2 IS ACTIVE!</strong> currentStep={{ currentStep }}, isStep(2)={{ isStep(2) }}
          </div>
          <h3 class="step-title mb-4">
            <i class="bi bi-door-open me-2"></i>
            Select Your Room Configuration
          </h3>
          <p class="step-description mb-4">Choose the room type that suits your needs</p>
          
          <!-- No Room Options Available -->
          <div *ngIf="package && (!package.roomOptions || package.roomOptions.length === 0)" class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            No room options available for this package. Standard room configuration will be applied.
            <div class="mt-3">
              <button class="btn btn-primary" (click)="nextStep()">
                Continue to Passenger Details <i class="bi bi-arrow-right ms-2"></i>
              </button>
            </div>
          </div>
          
          <!-- Room Options Available -->
          <div *ngIf="package && package.roomOptions && package.roomOptions.length > 0" class="row g-3 g-md-4">
            <div class="col-12 col-md-6" *ngFor="let room of package.roomOptions">
              <div class="card border-0 shadow-sm h-100 room-option-card-premium" 
                   [class.selected]="selectedRoomOption === room.id"
                   (click)="selectedRoomOption = room.id">
                <div class="card-body p-4">
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                      <h5 class="card-title mb-1">{{ room.name }}</h5>
                      <p class="text-muted small mb-0">{{ room.description }}</p>
                    </div>
                    <i class="bi bi-check-circle-fill text-success" 
                       *ngIf="selectedRoomOption === room.id" 
                       style="font-size: 1.5rem;"></i>
                  </div>
                  <div class="room-details mb-3">
                    <div class="detail-item">
                      <i class="bi bi-people me-2"></i>
                      Capacity: {{ room.adultCapacity }} Adults, {{ room.childCapacity }} Children
                    </div>
                    <div class="detail-item">
                      <i class="bi bi-bed me-2"></i>
                      Bed Type: {{ room.bedType }}
                    </div>
                  </div>
                  <div class="room-price">
                    <span class="text-muted small">Price Modifier:</span>
                    <span class="fw-bold ms-2" [class.text-success]="room.priceModifier === 0" [class.text-danger]="room.priceModifier > 0">
                      {{ room.priceModifier === 0 ? 'No Extra Charge' : (room.priceModifier > 0 ? '+' : '') }}{{ room.priceModifier | number }}%
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Auto-selected message for single room option -->
          <div *ngIf="package && package.roomOptions && package.roomOptions.length === 1 && selectedRoomOption" class="alert alert-success mt-3">
            <i class="bi bi-check-circle me-2"></i>
            Room option automatically selected. Click "Next" to continue.
          </div>
        </div>

        <!-- Step 3: Passenger Details -->
        <div *ngIf="isStep(3)" class="booking-step-content">
          <h3 class="step-title mb-4">
            <i class="bi bi-person-check me-2"></i>
            Passenger Information
          </h3>
          <p class="step-description mb-4">Please provide details for all travelers</p>
          
          <form [formGroup]="bookingForm">
            <div formArrayName="passengers">
              <div *ngFor="let passenger of passengers.controls; let i = index" class="card border-0 shadow-sm mb-4 passenger-card">
              <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0">
                  <i class="bi bi-person-circle me-2"></i>
                  Passenger {{ i + 1 }} Details
                </h5>
                <button type="button" class="btn btn-sm btn-outline-light" (click)="removePassenger(i)"
                        *ngIf="passengers.length > 1">
                  <i class="bi bi-trash me-1"></i>Remove
                </button>
              </div>
              <div class="card-body p-4" [formGroupName]="i">
                <div class="row">
                  <div class="col-md-2 mb-3">
                    <label class="form-label fw-bold">
                      <i class="bi bi-person-badge me-1"></i>Title *
                    </label>
                    <select class="form-select" formControlName="title"
                            [class.is-invalid]="passenger.get('title')?.invalid && passenger.get('title')?.touched">
                      <option *ngFor="let title of titles" [value]="title">{{ title }}</option>
                    </select>
                  </div>
                  <div class="col-md-5 mb-3">
                    <label class="form-label fw-bold">First Name *</label>
                    <input type="text" class="form-control" formControlName="firstName" 
                           placeholder="Enter first name"
                           [class.is-invalid]="passenger.get('firstName')?.invalid && passenger.get('firstName')?.touched">
                    <div class="invalid-feedback" *ngIf="passenger.get('firstName')?.invalid && passenger.get('firstName')?.touched">
                      First name is required
                    </div>
                  </div>
                  <div class="col-md-5 mb-3">
                    <label class="form-label fw-bold">Last Name *</label>
                    <input type="text" class="form-control" formControlName="lastName" 
                           placeholder="Enter last name"
                           [class.is-invalid]="passenger.get('lastName')?.invalid && passenger.get('lastName')?.touched">
                    <div class="invalid-feedback" *ngIf="passenger.get('lastName')?.invalid && passenger.get('lastName')?.touched">
                      Last name is required
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-3 mb-3">
                    <label class="form-label fw-bold">Age *</label>
                    <input type="number" class="form-control" formControlName="age" 
                           placeholder="Age" min="1" max="120"
                           [class.is-invalid]="passenger.get('age')?.invalid && passenger.get('age')?.touched">
                    <div class="invalid-feedback" *ngIf="passenger.get('age')?.invalid && passenger.get('age')?.touched">
                      Valid age required (1-120)
                    </div>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label class="form-label fw-bold">Gender *</label>
                    <select class="form-select" formControlName="gender"
                            [class.is-invalid]="passenger.get('gender')?.invalid && passenger.get('gender')?.touched">
                      <option *ngFor="let gender of genders" [value]="gender">{{ gender }}</option>
                    </select>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">
                      <i class="bi bi-envelope me-1"></i>Email *
                    </label>
                    <input type="email" class="form-control" formControlName="email" 
                           placeholder="email@example.com"
                           [class.is-invalid]="passenger.get('email')?.invalid && passenger.get('email')?.touched">
                    <div class="invalid-feedback" *ngIf="passenger.get('email')?.invalid && passenger.get('email')?.touched">
                      Valid email required
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">
                      <i class="bi bi-telephone me-1"></i>Phone *
                    </label>
                    <input type="tel" class="form-control" formControlName="phone" 
                           placeholder="10-digit mobile number" maxlength="10"
                           [class.is-invalid]="passenger.get('phone')?.invalid && passenger.get('phone')?.touched">
                    <div class="invalid-feedback" *ngIf="passenger.get('phone')?.invalid && passenger.get('phone')?.touched">
                      Valid 10-digit phone required
                    </div>
                  </div>
                </div>
              </div>
              </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
              <button type="button" class="btn btn-outline-primary" (click)="addPassenger()" *ngIf="passengers.length < 10">
                <i class="bi bi-plus-circle me-2"></i>Add Another Passenger
              </button>
            </div>
          </form>
          </div>

        <!-- Step 4: Add-ons -->
        <div *ngIf="isStep(4)" class="booking-step-content">
          <h3 class="step-title mb-4">
            <i class="bi bi-plus-circle me-2"></i>
            Enhance Your Trip (Optional)
          </h3>
          <p class="step-description mb-4">Add optional services to make your journey even better</p>
          
          <div class="row g-3 g-md-4">
            <div class="col-12 col-md-6" *ngFor="let addon of addOns">
              <div class="card border-0 shadow-sm addon-card" 
                   [class.selected]="selectedAddOns.includes(addon.id)"
                   (click)="toggleAddOn(addon.id)">
                <div class="card-body p-4">
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                      <h5 class="card-title mb-1">{{ addon.name }}</h5>
                      <p class="text-muted small mb-0">{{ addon.description }}</p>
                    </div>
                    <i class="bi bi-check-circle-fill text-success" 
                       *ngIf="selectedAddOns.includes(addon.id)" 
                       style="font-size: 1.5rem;"></i>
                  </div>
                  <div class="addon-price">
                    <span class="fw-bold text-primary">‚Çπ{{ addon.price | number }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div>

        <!-- Step 5: Review & Payment -->
        <div *ngIf="isStep(5)" class="booking-step-content">
          <h3 class="step-title mb-4">
            <i class="bi bi-check2-square me-2"></i>
            Review & Confirm Booking
          </h3>
          <p class="step-description mb-4">Please review all details before proceeding to payment</p>
          
          <!-- Booking Summary Review -->
          <div class="card border-0 shadow-md mb-4">
            <div class="card-body p-4">
              <h5 class="mb-4 d-flex align-items-center">
                <i class="bi bi-receipt-cutoff me-2 text-primary"></i>
                Booking Summary
              </h5>
              <div class="review-section">
                <div class="mb-2">
                  <strong>Package:</strong> {{ package.name }}
                </div>
                <div class="mb-2">
                  <strong>Departure:</strong> {{ departureDate | date:'EEEE, MMMM d, yyyy' }}
                </div>
                <div class="mb-2">
                  <strong>Travelers:</strong> {{ numberOfPassengers }} {{ numberOfPassengers === 1 ? 'person' : 'people' }}
                </div>
                <div class="mb-2">
                  <strong>Room:</strong> {{ selectedRoomName }}
                </div>
                <div class="mb-0">
                  <strong>Add-ons:</strong> {{ selectedAddOns.length > 0 ? selectedAddOns.length + ' selected' : 'None' }}
                </div>
              </div>
              <div class="review-total">
                <div class="d-flex justify-content-between mb-2">
                  <span class="text-muted">Package Price:</span>
                  <strong class="text-dark">‚Çπ{{ totalAmount | number }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2" *ngIf="addOnsTotal > 0">
                  <span class="text-muted">Add-ons:</span>
                  <strong class="text-dark">‚Çπ{{ addOnsTotal | number }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span class="text-muted">GST (5%):</span>
                  <strong class="text-dark">‚Çπ{{ ((totalAmount + addOnsTotal) * 0.05) | number }}</strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0 fw-bold">Total Amount:</h5>
                  <h4 class="mb-0 text-primary fw-bold">‚Çπ{{ ((totalAmount + addOnsTotal) * 1.05) | number }}</h4>
                </div>
              </div>
            </div>
          </div>

          <!-- Terms & Conditions -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="terms" required>
                <label class="form-check-label" for="terms">
                  I agree to the <a href="/terms-conditions" target="_blank">Terms & Conditions</a> and <a href="/privacy-policy" target="_blank">Privacy Policy</a>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="communication">
                <label class="form-check-label" for="communication">
                  I consent to receive booking updates and promotional communications
                </label>
              </div>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-primary btn-lg py-3 fw-bold" 
                    (click)="onSubmit()"
                    [disabled]="submitting || !bookingForm.valid">
              <span *ngIf="!submitting">
                <i class="bi bi-check-circle me-2"></i>Confirm & Proceed to Payment
              </span>
              <span *ngIf="submitting">
                <span class="spinner-border spinner-border-sm me-2"></span>Processing Booking...
              </span>
            </button>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="booking-navigation mt-4" *ngIf="currentStep < 5">
          <div class="d-flex justify-content-between flex-column flex-md-row gap-2 gap-md-0">
            <button class="btn btn-outline-secondary order-2 order-md-1" (click)="previousStep()" [disabled]="isStep(1)">
              <i class="bi bi-arrow-left me-2"></i>Previous
            </button>
            <button class="btn btn-primary order-1 order-md-2" (click)="nextStep()" [disabled]="!canProceedToNextStep()">
              Next
              <i class="bi bi-arrow-right ms-2"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Booking Summary Sidebar - Right Side -->
      <div class="col-12 col-lg-4">
        <div class="card border-0 shadow-lg booking-summary-card">
          <div class="card-header text-white py-3">
            <h5 class="mb-0">
              <i class="bi bi-receipt me-2"></i>Booking Summary
            </h5>
          </div>
          <div class="card-body p-4">
            <!-- Package Info -->
            <div class="summary-section mb-4">
              <h6 class="summary-section-title mb-3">PACKAGE DETAILS</h6>
              <div class="summary-item mb-2">
                <span class="text-muted">Package:</span>
                <strong>{{ package.name }}</strong>
              </div>
              <div class="summary-item mb-2">
                <span class="text-muted">Duration:</span>
                <strong>{{ package.days }}D / {{ package.nights }}N</strong>
              </div>
              <div class="summary-item mb-2">
                <span class="text-muted">Departure:</span>
                <strong>{{ departureDate | date:'dd MMM yyyy' }}</strong>
              </div>
            </div>

            <hr class="my-4">

            <!-- Price Breakdown -->
            <div class="summary-section mb-4">
              <h6 class="summary-section-title mb-3">Price Breakdown</h6>
              <div class="summary-item mb-2">
                <span class="text-muted">Price per person:</span>
                <strong>{{ package.currency }} {{ package.basePrice | number }}</strong>
              </div>
              <div class="summary-item mb-2">
                <span class="text-muted">Number of travelers:</span>
                <strong>√ó {{ numberOfPassengers }}</strong>
              </div>
              <div class="summary-item mb-3" *ngIf="package.emiAvailable">
                <span class="text-muted">GST (5%):</span>
                <strong>{{ package.currency }} {{ (totalAmount * 0.05) | number }}</strong>
              </div>
            </div>

            <!-- Total -->
              <div class="summary-total mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h5 class="mb-0">Subtotal:</h5>
                  <h4 class="mb-0 fw-bold">{{ package.currency }} {{ totalAmount | number }}</h4>
                </div>
                <div class="d-flex justify-content-between align-items-center" *ngIf="package.emiAvailable">
                  <span class="small">GST (5%):</span>
                  <strong class="small">{{ package.currency }} {{ (totalAmount * 0.05) | number }}</strong>
                </div>
                <hr class="my-2">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Total Amount:</h5>
                  <h3 class="mb-0 fw-bold">{{ package.currency }} {{ (totalAmount * 1.05) | number }}</h3>
                </div>
                <small class="d-block mt-2" *ngIf="package.emiAvailable" style="opacity: 0.9;">
                  <i class="bi bi-credit-card me-1"></i>
                  EMI starting from ‚Çπ{{ package.emiStartingFrom | number }}/month
                </small>
              </div>

            <!-- Trust Badges -->
            <div class="trust-badges">
              <div class="trust-item mb-2">
                <i class="bi bi-shield-check me-2"></i>
                <small>100% Secure Payment</small>
              </div>
              <div class="trust-item mb-2">
                <i class="bi bi-telephone me-2"></i>
                <small>24/7 Customer Support</small>
              </div>
              <div class="trust-item">
                <i class="bi bi-arrow-counterclockwise me-2"></i>
                <small>Easy Cancellation</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="success-modal-backdrop" *ngIf="showSuccessModal" (click)="closeSuccessModal()">
  <div class="success-modal-content" (click)="$event.stopPropagation()">
    <div class="success-icon">
      <i class="bi bi-check-circle-fill"></i>
    </div>
    <h2 class="success-title">Booking Confirmed!</h2>
    <p class="success-message">
      Your booking has been successfully confirmed. A confirmation email has been sent to your registered email address.
    </p>
    <div class="booking-reference-box">
      <div class="reference-label">Booking Reference</div>
      <div class="reference-code">{{ bookingReference }}</div>
    </div>
    <div class="success-actions">
      <button class="btn btn-primary btn-lg" (click)="viewMyBookings()">
        <i class="bi bi-calendar-check me-2"></i>
        View My Bookings
      </button>
      <button class="btn btn-outline-secondary btn-lg" (click)="closeSuccessModal()">
        Close
      </button>
    </div>
  </div>
</div>
